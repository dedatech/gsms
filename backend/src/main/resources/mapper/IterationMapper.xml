<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gsms.gsms.repository.IterationMapper">

    <resultMap id="IterationResultMap" type="com.gsms.gsms.model.entity.Iteration">
        <id column="id" property="id"/>
        <result column="project_id" property="projectId"/>
        <result column="project_name" property="projectName"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="status" property="status"
                typeHandler="com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler"/>
        <result column="plan_start_date" property="planStartDate"/>
        <result column="plan_end_date" property="planEndDate"/>
        <result column="actual_start_date" property="actualStartDate"/>
        <result column="actual_end_date" property="actualEndDate"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="update_time" property="updateTime"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <sql id="selectAllFields">
        id, project_id, name, description, status, plan_start_date, plan_end_date,
        actual_start_date, actual_end_date, create_user_id, create_time, update_time, is_deleted
    </sql>

    <select id="selectById" parameterType="long" resultMap="IterationResultMap">
        SELECT i.id, i.project_id, p.name as project_name, i.name, i.description, i.status,
               i.plan_start_date, i.plan_end_date, i.actual_start_date, i.actual_end_date,
               i.create_user_id, i.create_time, i.update_time, i.is_deleted
        FROM gsms_iteration i
        LEFT JOIN gsms_project p ON i.project_id = p.id
        WHERE i.id = #{id} AND i.is_deleted = 0
    </select>

    <select id="selectByProjectId" parameterType="long" resultMap="IterationResultMap">
        SELECT <include refid="selectAllFields"/>
        FROM gsms_iteration
        WHERE project_id = #{projectId} AND is_deleted = 0
        ORDER BY plan_start_date DESC
    </select>

    <select id="selectByCondition" resultMap="IterationResultMap">
        SELECT i.id, i.project_id, p.name as project_name, i.name, i.description, i.status,
               i.plan_start_date, i.plan_end_date, i.actual_start_date, i.actual_end_date,
               i.create_user_id, i.create_time, i.update_time, i.is_deleted
        FROM gsms_iteration i
        LEFT JOIN gsms_project p ON i.project_id = p.id
        WHERE 1=1
        <if test="projectId != null">
            AND i.project_id = #{projectId}
        </if>
        <if test="status != null">
            AND i.status = #{status, typeHandler=com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler}
        </if>
        AND i.is_deleted = 0
        ORDER BY i.plan_start_date DESC
    </select>

    <select id="selectByConditionWithStatus" parameterType="map" resultMap="IterationResultMap">
        SELECT <include refid="selectAllFields"/>
        FROM gsms_iteration
        WHERE 1=1
        <if test="projectId != null">
            AND project_id = #{projectId}
        </if>
        <if test="status != null">
            AND status = #{status, typeHandler=com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler}
        </if>
        AND is_deleted = 0
        ORDER BY plan_start_date DESC
    </select>

    <insert id="insert" parameterType="com.gsms.gsms.model.entity.Iteration"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO gsms_iteration(project_id, name, description, status, plan_start_date, 
                             plan_end_date, create_user_id)
        VALUES(#{projectId}, #{name}, #{description}, 
               #{status, typeHandler=com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler}, 
               #{planStartDate}, #{planEndDate}, #{createUserId})
    </insert>

    <update id="update" parameterType="com.gsms.gsms.model.entity.Iteration">
        UPDATE gsms_iteration
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="status != null">status = #{status, typeHandler=com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler},</if>
            <if test="planStartDate != null">plan_start_date = #{planStartDate},</if>
            <if test="planEndDate != null">plan_end_date = #{planEndDate},</if>
            <if test="actualStartDate != null">actual_start_date = #{actualStartDate},</if>
            <if test="actualEndDate != null">actual_end_date = #{actualEndDate},</if>
        </set>
        WHERE id = #{id}
    </update>

    <update id="deleteById" parameterType="long">
        UPDATE gsms_iteration SET is_deleted = 1, update_time = CURRENT_TIMESTAMP WHERE id = #{id}
    </update>

</mapper>