<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gsms.gsms.repository.OperationLogMapper">

    <!-- 结果映射 -->
    <resultMap id="OperationLogResultMap" type="com.gsms.gsms.model.entity.OperationLog">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="username" property="username"/>
        <result column="operation_type" property="operationType"/>
        <result column="module" property="module"/>
        <result column="business_type" property="businessType"/>
        <result column="business_id" property="businessId"/>
        <result column="old_value" property="oldValue"/>
        <result column="new_value" property="newValue"/>
        <result column="operation_content" property="operationContent"/>
        <result column="ip_address" property="ipAddress"/>
        <result column="status" property="status"/>
        <result column="error_message" property="errorMessage"/>
        <result column="operation_time" property="operationTime"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- 查询所有字段 -->
    <sql id="selectAllFields">
        id, user_id, username, operation_type, module, business_type, business_id,
        old_value, new_value, operation_content,
        ip_address, status, error_message, operation_time, create_time
    </sql>

    <!-- 插入操作日志 -->
    <insert id="insert" parameterType="com.gsms.gsms.model.entity.OperationLog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `sys_operation_log`
        (user_id, username, operation_type, module, business_type, business_id, old_value, new_value,
         operation_content, ip_address, status, error_message, operation_time)
        VALUES
        (#{userId}, #{username}, #{operationType}, #{module}, #{businessType}, #{businessId},
         #{oldValue}, #{newValue}, #{operationContent}, #{ipAddress}, #{status}, #{errorMessage}, #{operationTime})
    </insert>

    <!-- 根据条件查询操作日志 -->
    <select id="findByCondition" resultMap="OperationLogResultMap">
        SELECT <include refid="selectAllFields"/>
        FROM `sys_operation_log`
        <where>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="module != null">
                AND module = #{module}
            </if>
            <if test="operationType != null">
                AND operation_type = #{operationType}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="startTime != null and startTime != ''">
                AND operation_time &gt;= #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND operation_time &lt;= #{endTime}
            </if>
        </where>
        ORDER BY operation_time DESC
    </select>

    <!-- 根据ID查询操作日志 -->
    <select id="selectById" parameterType="long" resultMap="OperationLogResultMap">
        SELECT <include refid="selectAllFields"/>
        FROM `sys_operation_log`
        WHERE id = #{id}
    </select>

</mapper>
